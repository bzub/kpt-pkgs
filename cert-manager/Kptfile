apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: cert-manager
pipeline:
  mutators:
    - name: add-port-protocol
      image: gcr.io/kpt-fn/starlark:unstable
      configMap:
        source: |
          def addportprotocol(resources):
            for resource in resources:
              spec = resource.get("spec")
              if not spec:
                continue

              ports = spec.get("ports")
              if not ports:
                continue

              for port in ports:
                port.setdefault("protocol", "TCP")

          addportprotocol(ctx.resource_list["items"])
      selectors:
        - kind: Service
