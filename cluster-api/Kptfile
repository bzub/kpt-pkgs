apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: cluster-api
info:
  description: |
    This package is for maintenance on the packages under `cluster-api`.
    It is not intended to be consumed as a package of resources for deployment.
pipeline:
  mutators:
  - name: normalize-feature-gates-flag
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-value-regex: '--feature-gates=.*'
      put-value: '--feature-gates=MachinePool=false,ClusterResourceSet=false'
  - name: normalize-enable-leader-election-flag
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-value: '--enable-leader-election'
      put-value: '--enable-leader-election=true'
  - name: create-setters-for-capi-provider-namespaces
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-value-regex: '(.*)(cabpt-system|cacppt-system|capd-system|capi-kubeadm-bootstrap-system|capi-kubeadm-control-plane-system|capi-system|sidero-system)(.*)'
      put-comment: 'kpt-set: ${1}${capi-provider-namespace}${3}'
  - name: create-setters-for-capi-webhook-system-namespace
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-value-regex: '(.*)(capi-webhook-system)(.*)'
      put-comment: 'kpt-set: ${1}${capi-webhook-system-namespace}${3}'
  - name: add-paused-fields
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-path: 'spec.paused'
      put-value: false
    selectors:
    - kind: Cluster
    - kind: MachineDeployment
  - name: add-paused-setters
    image: gcr.io/kpt-fn/search-replace:unstable
    configMap:
      by-path: 'spec.paused'
      put-comment: 'kpt-set: ${paused}'
    selectors:
    - kind: Cluster
    - kind: MachineDeployment
  - name: set-cert-manager-dependencies
    image: gcr.io/kpt-fn/set-annotations:unstable
    configMap:
      config.kubernetes.io/depends-on: apps/namespaces/cert-manager/Deployment/cert-manager-webhook
    selectors:
    - kind: Certificate
    - kind: Issuer
    - namespace: capi-webhook-system
      kind: Deployment
